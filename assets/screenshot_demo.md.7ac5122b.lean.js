import{R as pe,r as c,j as H,a as R,F as ye,b as ve,c as be}from"./chunks/jsx-runtime.2f7c3433.js";import{a0 as Me,f as $e,k as ze,o as Ee,c as De,v as Pe}from"./chunks/framework.b7e7358f.js";var D=(t=>(t[t.Edit=0]="Edit",t[t.Source=1]="Source",t))(D||{});function U({image:t,width:e,height:n,history:o,bounds:s}){return new Promise((r,i)=>{const a=document.createElement("canvas"),d=s.width*window.devicePixelRatio,f=s.height*window.devicePixelRatio;a.width=d,a.height=f;const l=a.getContext("2d");if(!l)return i(new Error("convert image to blob fail"));const h=t.naturalWidth/e,u=t.naturalHeight/n;l.imageSmoothingEnabled=!0,l.imageSmoothingQuality="low",l.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0),l.clearRect(0,0,s.width,s.height),l.drawImage(t,s.x*h,s.y*u,s.width*h,s.height*u,0,0,s.width,s.height),o.stack.slice(0,o.index+1).forEach(g=>{g.type===D.Source&&g.draw(l,g)}),a.toBlob(g=>{if(!g)return i(new Error("canvas toBlob fail"));r(g)},"image/png")})}const we={magnifier_position_label:"坐标",operation_ok_title:"确定",operation_cancel_title:"取消",operation_save_title:"保存",operation_redo_title:"重做",operation_undo_title:"撤销",operation_mosaic_title:"马赛克",operation_text_title:"文本",operation_brush_title:"画笔",operation_arrow_title:"箭头",operation_ellipse_title:"椭圆",operation_rectangle_title:"矩形",operation_search_title:"搜图",operation_scan_title:"扫码",operation_pin_title:"贴图"},me=pe.createContext({store:{url:void 0,image:null,width:0,height:0,lang:we,emiterRef:{current:{}},canvasContextRef:{current:null},history:{index:-1,stack:[]},bounds:null,cursor:"move",operation:void 0},dispatcher:{call:void 0,setHistory:void 0,setBounds:void 0,setCursor:void 0,setOperation:void 0}});function re(){const{dispatcher:t}=c.useContext(me);return t}function L(){const{store:t}=c.useContext(me);return t}function J(){const{bounds:t}=L(),{setBounds:e}=re(),n=c.useCallback(s=>{e==null||e(s)},[e]),o=c.useCallback(()=>{e==null||e(null)},[e]);return[t,{set:n,reset:o}]}function Y(){const{lang:t}=L();return t}const q=100,Q=80,Oe=c.memo(function({x:e,y:n}){const{width:o,height:s,image:r}=L(),i=Y(),[a,d]=c.useState(null),f=c.useRef(null),l=c.useRef(null),h=c.useRef(null),[u,g]=c.useState("000000");return c.useLayoutEffect(()=>{if(!f.current)return;const m=f.current.getBoundingClientRect();let v=e+20,S=n+20;v+m.width>o&&(v=e-m.width-20),S+m.height>s&&(S=n-m.height-20),v<0&&(v=0),S<0&&(S=0),d({x:v,y:S})},[o,s,e,n]),c.useEffect(()=>{if(!r||!l.current){h.current=null;return}if(h.current||(h.current=l.current.getContext("2d")),!h.current)return;const m=h.current;m.clearRect(0,0,q,Q);const v=r.naturalWidth/o,S=r.naturalHeight/s;m.drawImage(r,e*v-q/2,n*S-Q/2,q,Q,0,0,q,Q);const{data:C}=m.getImageData(Math.floor(q/2),Math.floor(Q/2),1,1),x=Array.from(C.slice(0,3)).map(M=>M>=16?M.toString(16):`0${M.toString(16)}`).join("").toUpperCase();g(x)},[o,s,r,e,n]),H("div",{ref:f,className:"screenshots-magnifier",style:{transform:`translate(${a==null?void 0:a.x}px, ${a==null?void 0:a.y}px)`},children:[R("div",{className:"screenshots-magnifier-body",children:R("canvas",{ref:l,className:"screenshots-magnifier-body-canvas",width:q,height:Q})}),H("div",{className:"screenshots-magnifier-footer",children:[H("div",{className:"screenshots-magnifier-footer-item",children:[i.magnifier_position_label,": (",e,",",n,")"]}),H("div",{className:"screenshots-magnifier-footer-item",children:["RGB: #",u]})]})]})});function Be({x:t,y:e},{x:n,y:o},s,r){return t>n&&([t,n]=[n,t]),e>o&&([e,o]=[o,e]),t<0&&(t=0),n>s&&(n=s),e<0&&(e=0),o>r&&(o=r),{x:t,y:e,width:n-t,height:o-e}}const Le=c.memo(function(){const{url:e,image:n,width:o,height:s}=L(),[r,i]=J(),a=c.useRef(null),d=c.useRef(null),f=c.useRef(!1),[l,h]=c.useState(null),u=c.useCallback((m,v)=>{if(!a.current)return;const{x:S,y:C}=a.current.getBoundingClientRect();i.set(Be({x:m.x-S,y:m.y-C},{x:v.x-S,y:v.y-C},o,s))},[o,s,i]),g=c.useCallback(m=>{d.current||r||m.button!==0||(d.current={x:m.clientX,y:m.clientY},f.current=!1)},[r]);return c.useEffect(()=>{const m=S=>{if(a.current){const C=a.current.getBoundingClientRect();S.clientX<C.left||S.clientY<C.top||S.clientX>C.right||S.clientY>C.bottom?h(null):h({x:S.clientX-C.x,y:S.clientY-C.y})}d.current&&(u(d.current,{x:S.clientX,y:S.clientY}),f.current=!0)},v=S=>{d.current&&(f.current&&u(d.current,{x:S.clientX,y:S.clientY}),d.current=null,f.current=!1)};return window.addEventListener("mousemove",m),window.addEventListener("mouseup",v),()=>{window.removeEventListener("mousemove",m),window.removeEventListener("mouseup",v)}},[u]),c.useLayoutEffect(()=>{(!n||r)&&h(null)},[n,r]),!e||!n?null:H("div",{ref:a,className:"screenshots-background",onMouseDown:g,children:[R("img",{className:"screenshots-background-image",src:e}),R("div",{className:"screenshots-background-mask"}),l&&!r&&R(Oe,{x:l==null?void 0:l.x,y:l==null?void 0:l.y})]})});function A(){const{cursor:t}=L(),{setCursor:e}=re(),n=c.useCallback(s=>{e==null||e(s)},[e]),o=c.useCallback(()=>{e==null||e("move")},[e]);return[t,{set:n,reset:o}]}function G(){const{emiterRef:t}=L(),e=c.useCallback((r,i)=>{const a=t.current;Array.isArray(a[r])?a[r].push(i):a[r]=[i]},[t]),n=c.useCallback((r,i)=>{const a=t.current;if(Array.isArray(a[r])){const d=a[r].findIndex(f=>f===i);d!==-1&&a[r].splice(d,1)}},[t]),o=c.useCallback((r,...i)=>{const a=t.current;Array.isArray(a[r])&&a[r].forEach(d=>d(...i))},[t]),s=c.useCallback(()=>{t.current={}},[t]);return{on:e,off:n,emit:o,reset:s}}function T(){const{history:t}=L(),{setHistory:e}=re(),n=c.useCallback(l=>{const{index:h,stack:u}=t;u.forEach(g=>{g.type===D.Source&&(g.isSelected=!1)}),l.type===D.Source?l.isSelected=!0:l.type===D.Edit&&(l.source.isSelected=!0),u.splice(h+1),u.push(l),e==null||e({index:u.length-1,stack:u})},[t,e]),o=c.useCallback(()=>{const{stack:l}=t;l.pop(),e==null||e({index:l.length-1,stack:l})},[t,e]),s=c.useCallback(()=>{const{index:l,stack:h}=t,u=h[l];u&&(u.type===D.Source?u.isSelected=!1:u.type===D.Edit&&u.source.editHistory.pop()),e==null||e({index:l<=0?-1:l-1,stack:h})},[t,e]),r=c.useCallback(()=>{const{index:l,stack:h}=t,u=h[l+1];u&&(u.type===D.Source?u.isSelected=!1:u.type===D.Edit&&u.source.editHistory.push(u)),e==null||e({index:l>=h.length-1?h.length-1:l+1,stack:h})},[t,e]),i=c.useCallback(l=>{e==null||e({...l})},[e]),a=c.useCallback(l=>{t.stack.forEach(h=>{h.type===D.Source&&(h===l?h.isSelected=!0:h.isSelected=!1)}),e==null||e({...t})},[t,e]),d=c.useCallback(()=>{t.stack.forEach(l=>{l.type===D.Source&&(l.isSelected=!1)}),e==null||e({...t})},[t,e]),f=c.useCallback(()=>{e==null||e({index:-1,stack:[]})},[e]);return[{index:t.index,stack:t.stack,top:t.stack.slice(t.index,t.index+1)[0]},{push:n,pop:o,undo:s,redo:r,set:i,select:a,clearSelect:d,reset:f}]}function j(){const{operation:t}=L(),{setOperation:e}=re(),n=c.useCallback(s=>{e==null||e(s)},[e]),o=c.useCallback(()=>{e==null||e(void 0)},[e]);return[t,{set:n,reset:o}]}function Te({x:t,y:e},{x:n,y:o},s,r,i,a){return t>n&&([t,n]=[n,t]),e>o&&([e,o]=[o,e]),t<0&&(t=0,a==="move"&&(n=s.width)),n>r&&(n=r,a==="move"&&(t=n-s.width)),e<0&&(e=0,a==="move"&&(o=s.height)),o>i&&(o=i,a==="move"&&(e=o-s.height)),{x:t,y:e,width:Math.max(n-t,1),height:Math.max(o-e,1)}}function Ne(t,e,n,o){const s=t.clientX-n.x,r=t.clientY-n.y;let i=o.x,a=o.y,d=o.x+o.width,f=o.y+o.height;switch(e){case"top":a+=r;break;case"top-right":d+=s,a+=r;break;case"right":d+=s;break;case"right-bottom":d+=s,f+=r;break;case"bottom":f+=r;break;case"bottom-left":i+=s,f+=r;break;case"left":i+=s;break;case"left-top":i+=s,a+=r;break;case"move":i+=s,a+=r,d+=s,f+=r;break}return[{x:i,y:a},{x:d,y:f}]}function He(t,e,n,o){if(!e)return!1;const s=document.createElement("canvas");s.width=t.width,s.height=t.height;const r=s.getContext("2d");if(!r)return!1;const{left:i,top:a}=e.getBoundingClientRect(),d=o.clientX-i,f=o.clientY-a;return[...n.stack.slice(0,n.index+1)].reverse().find(h=>{var u;return h.type!==D.Source?!1:(r.clearRect(0,0,t.width,t.height),(u=h.isHit)==null?void 0:u.call(h,r,h,{x:d,y:f}))})}const We=["top","right","bottom","left"],Ie=["top","top-right","right","right-bottom","bottom","bottom-left","left","left-top"],Fe=c.memo(c.forwardRef(function(e,n){const{url:o,image:s,width:r,height:i}=L(),a=G(),[d]=T(),[f]=A(),[l,h]=J(),[u]=j(),g=c.useRef(),m=c.useRef(null),v=c.useRef(null),S=c.useRef(null),C=c.useRef(null),x=l&&!d.stack.length&&!u,M=c.useCallback(()=>{if(!l||!C.current)return;const w=C.current;w.imageSmoothingEnabled=!0,w.imageSmoothingQuality="low",w.clearRect(0,0,l.width,l.height),d.stack.slice(0,d.index+1).forEach(_=>{_.type===D.Source&&_.draw(w,_)})},[l,C,d]),y=c.useCallback((w,_)=>{if(!(w.button!==0||!l))if(!u)g.current=_,m.current={x:w.clientX,y:w.clientY},v.current={x:l.x,y:l.y,width:l.width,height:l.height};else{const k=He(l,S.current,d,w.nativeEvent);k?a.emit("drawselect",k,w.nativeEvent):a.emit("mousedown",w.nativeEvent)}},[l,u,a,d]),p=c.useCallback(w=>{if(!g.current||!m.current||!v.current||!l)return;const _=Ne(w,g.current,m.current,v.current);h.set(Te(_[0],_[1],l,r,i,g.current))},[r,i,l,h]);return c.useLayoutEffect(()=>{if(!s||!l||!S.current){C.current=null;return}C.current||(C.current=S.current.getContext("2d")),M()},[s,l,M]),c.useEffect(()=>{const w=k=>{if(u)a.emit("mousemove",k);else{if(!g.current||!m.current||!v.current)return;p(k)}},_=k=>{if(u)a.emit("mouseup",k);else{if(!g.current||!m.current||!v.current)return;p(k),g.current=void 0,m.current=null,v.current=null}};return window.addEventListener("mousemove",w),window.addEventListener("mouseup",_),()=>{window.removeEventListener("mousemove",w),window.removeEventListener("mouseup",_)}},[p,u,a]),c.useImperativeHandle(n,()=>C.current),H("div",{className:"screenshots-canvas",style:{width:(l==null?void 0:l.width)||0,height:(l==null?void 0:l.height)||0,transform:l?`translate(${l.x}px, ${l.y}px)`:"none"},children:[H("div",{className:"screenshots-canvas-body",children:[R("img",{className:"screenshots-canvas-image",src:o,style:{width:r,height:i,transform:l?`translate(${-l.x}px, ${-l.y}px)`:"none"}}),R("canvas",{ref:S,className:"screenshots-canvas-panel",width:(l==null?void 0:l.width)||0,height:(l==null?void 0:l.height)||0})]}),R("div",{className:"screenshots-canvas-mask",style:{cursor:f},onMouseDown:w=>y(w,"move"),children:x&&H("div",{className:"screenshots-canvas-size",children:[l.width," × ",l.height]})}),We.map(w=>R("div",{className:`screenshots-canvas-border-${w}`},w)),x&&Ie.map(w=>R("div",{className:`screenshots-canvas-point-${w}`,onMouseDown:_=>y(_,w)},w))]})}));function K(){const t=re();return c.useCallback((n,...o)=>{var s;(s=t.call)==null||s.call(t,n,...o)},[t])}function I(){const{canvasContextRef:t}=L();return t}function Z(){const t=G(),[,e]=J(),[,n]=A(),[,o]=T(),[,s]=j();return c.useCallback(()=>{t.reset(),o.reset(),e.reset(),n.reset(),s.reset()},[t,o,e,n,s])}const Xe=c.memo(function({open:e,content:n,children:o}){const s=c.useRef(null),r=c.useRef(null),i=c.useRef(null),a=c.useContext(ke),[d,f]=c.useState("bottom"),[l,h]=c.useState(null),[u,g]=c.useState(0),m=()=>(r.current||(r.current=document.createElement("div")),r.current);return c.useEffect(()=>{const v=m();return e&&document.body.appendChild(v),()=>{v.remove()}},[e]),c.useEffect(()=>{if(!e||!a||!s.current||!i.current)return;const v=s.current.getBoundingClientRect(),S=i.current.getBoundingClientRect();let C=d,x=v.left+v.width/2,M=v.top+v.height,y=u;if(x+S.width/2>a.x+a.width){const p=x;x=a.x+a.width-S.width/2,y=p-x}if(x<a.x+S.width/2){const p=x;x=a.x+S.width/2,y=p-x}M>window.innerHeight-S.height&&(C==="bottom"&&(C="top"),M=v.top-S.height),M<0&&(C==="top"&&(C="bottom"),M=v.top+v.height),C!==d&&f(C),((l==null?void 0:l.x)!==x||l.y!==M)&&h({x,y:M}),y!==u&&g(y)}),H(ye,{children:[c.cloneElement(o,{ref:s}),e&&n&&ve.createPortal(H("div",{ref:i,className:"screenshots-option",style:{visibility:l?"visible":"hidden",transform:`translate(${(l==null?void 0:l.x)??0}px, ${(l==null?void 0:l.y)??0}px)`},"data-placement":d,children:[R("div",{className:"screenshots-option-container",children:n}),R("div",{className:"screenshots-option-arrow",style:{marginLeft:u}})]}),m())]})});const N=c.memo(function({title:e,icon:n,checked:o,disabled:s,option:r,onClick:i}){const a=["screenshots-button"],d=c.useCallback(f=>{s||!i||i(f)},[s,i]);return o&&a.push("screenshots-button-checked"),s&&a.push("screenshots-button-disabled"),R(Xe,{open:o,content:r,children:R("div",{className:a.join(" "),title:e,onClick:d,children:R("span",{className:n})})})});function Ye(){const{image:t,width:e,height:n,history:o,bounds:s,lang:r}=L(),i=I(),[,a]=T(),d=K(),f=Z(),l=c.useCallback(()=>{a.clearSelect(),setTimeout(()=>{!i.current||!t||!s||U({image:t,width:e,height:n,history:o,bounds:s}).then(h=>{d("onOk",h,s),f()})})},[i,a,t,e,n,o,s,d,f]);return R(N,{title:r.operation_ok_title,icon:"icon-ok",onClick:l})}function Ve(){const t=K(),e=Z(),n=Y(),o=c.useCallback(()=>{t("onCancel"),e()},[t,e]);return R(N,{title:n.operation_cancel_title,icon:"icon-cancel",onClick:o})}function Ae(){const{image:t,width:e,height:n,history:o,bounds:s,lang:r}=L(),i=I(),[,a]=T(),d=K(),f=Z(),l=c.useCallback(()=>{a.clearSelect(),setTimeout(()=>{!i.current||!t||!s||U({image:t,width:e,height:n,history:o,bounds:s}).then(h=>{d("onSave",h,s),f()})})},[i,a,t,e,n,o,s,d,f]);return R(N,{title:r.operation_save_title,icon:"icon-save",onClick:l})}function je(){const t=Y(),[e,n]=T(),o=c.useCallback(()=>{n.redo()},[n]);return R(N,{title:t.operation_redo_title,icon:"icon-redo",disabled:!e.stack.length||e.stack.length-1===e.index,onClick:o})}function Ue(){const t=Y(),[e,n]=T(),o=c.useCallback(()=>{n.undo()},[n]);return R(N,{title:t.operation_undo_title,icon:"icon-undo",disabled:e.index===-1,onClick:o})}const Ce=c.memo(function({value:e,onChange:n}){return R("div",{className:"screenshots-size",children:[3,6,9].map(s=>{const r=["screenshots-size-item"];return s===e&&r.push("screenshots-size-active"),R("div",{className:r.join(" "),onClick:()=>n&&n(s),children:R("div",{className:"screenshots-size-pointer",style:{width:s*1.8,height:s*1.8}})},s)})})});function ee(t){const e=G();c.useEffect(()=>(e.on("mousedown",t),()=>{e.off("mousedown",t)}),[t,e])}function te(t){const e=G();c.useEffect(()=>(e.on("mousemove",t),()=>{e.off("mousemove",t)}),[t,e])}function ne(t){const e=G();c.useEffect(()=>(e.on("mouseup",t),()=>{e.off("mouseup",t)}),[t,e])}function le(t,e,n){if(!n)return[0,0,0,0];const{data:o,width:s}=n,r=e*s*4+t*4;return Array.from(o.slice(r,r+4))}function qe(t,e){const{tiles:n,size:o}=e.data;n.forEach(s=>{const r=Math.round(s.color[0]),i=Math.round(s.color[1]),a=Math.round(s.color[2]),d=s.color[3]/255;t.fillStyle=`rgba(${r}, ${i}, ${a}, ${d})`,t.fillRect(s.x-o/2,s.y-o/2,o,o)})}function Qe(){const t=Y(),{image:e,width:n,height:o}=L(),[s,r]=j(),i=I(),[a,d]=T(),[f]=J(),[,l]=A(),[h,u]=c.useState(3),g=c.useRef(null),m=c.useRef(null),v=s==="Mosaic",S=c.useCallback(()=>{r.set("Mosaic"),l.set("crosshair")},[r,l]),C=c.useCallback(()=>{v||(S(),d.clearSelect())},[v,S,d]),x=c.useCallback(p=>{if(!v||m.current||!g.current||!i.current)return;const w=i.current.canvas.getBoundingClientRect(),_=p.clientX-w.x,k=p.clientY-w.y,z=h*2;m.current={name:"Mosaic",type:D.Source,data:{size:z,tiles:[{x:_,y:k,color:le(_,k,g.current)}]},editHistory:[],draw:qe}},[v,h,i]),M=c.useCallback(p=>{if(!v||!m.current||!i.current||!g.current)return;const w=i.current.canvas.getBoundingClientRect(),_=p.clientX-w.x,k=p.clientY-w.y,z=m.current.data.size,E=m.current.data.tiles;let $=E[E.length-1];if(!$)E.push({x:_,y:k,color:le(_,k,g.current)});else{const ce=$.x-_,P=$.y-k;let W=Math.sqrt(ce**2+P**2);const de=-P/W,fe=-ce/W;for(;W>z;){const se=Math.floor($.x+z*fe),oe=Math.floor($.y+z*de);$={x:se,y:oe,color:le(se,oe,g.current)},E.push($),W-=z}W>z/2&&E.push({x:_,y:k,color:le(_,k,g.current)})}a.top!==m.current?d.push(m.current):d.set(a)},[v,i,a,d]),y=c.useCallback(()=>{v&&(m.current=null)},[v]);return ee(x),te(M),ne(y),c.useEffect(()=>{if(!f||!e||!v)return;const p=document.createElement("canvas"),w=p.getContext("2d");if(!w)return;p.width=f.width,p.height=f.height;const _=e.naturalWidth/n,k=e.naturalHeight/o;w.drawImage(e,f.x*_,f.y*k,f.width*_,f.height*k,0,0,f.width,f.height),g.current=w.getImageData(0,0,f.width,f.height)},[n,o,f,e,v]),R(N,{title:t.operation_mosaic_title,icon:"icon-mosaic",checked:v,onClick:C,option:R(Ce,{value:h,onChange:u})})}const Je=c.memo(function({value:e,onChange:n}){return R("div",{className:"screenshots-color",children:["#ee5126","#fceb4d","#90e746","#51c0fa","#7a7a7a","#ffffff"].map(s=>{const r=["screenshots-color-item"];return s===e&&r.push("screenshots-color-active"),R("div",{className:r.join(" "),style:{backgroundColor:s},onClick:()=>n&&n(s)},s)})})});const ie=c.memo(function({size:e,color:n,onSizeChange:o,onColorChange:s}){return H("div",{className:"screenshots-sizecolor",children:[R(Ce,{value:e,onChange:o}),R(Je,{value:n,onChange:s})]})}),Ge=`
min-width: 0 !important;
width: 0 !important;
min-height: 0 !important;
height:0 !important;
visibility: hidden !important;
overflow: hidden !important;
position: absolute !important;
z-index: -1000 !important;
top:0 !important;
right:0 !important;
`,Ke=["letter-spacing","line-height","padding-top","padding-bottom","font-family","font-weight","font-size","font-variant","text-rendering","text-transform","text-indent","padding-left","padding-right","border-width","box-sizing","white-space","word-break"];let V;function Ze(t){const e=window.getComputedStyle(t),n=e.getPropertyValue("box-sizing")||e.getPropertyValue("-moz-box-sizing")||e.getPropertyValue("-webkit-box-sizing"),o=parseFloat(e.getPropertyValue("padding-bottom"))+parseFloat(e.getPropertyValue("padding-top")),s=parseFloat(e.getPropertyValue("border-bottom-width"))+parseFloat(e.getPropertyValue("border-top-width"));return{sizingStyle:Ke.map(i=>`${i}:${e.getPropertyValue(i)}`).join(";"),paddingSize:o,borderSize:s,boxSizing:n}}function et(t,e,n,o){V||(V=document.createElement("textarea"),V.setAttribute("tab-index","-1"),document.body.appendChild(V));const{paddingSize:s,borderSize:r,boxSizing:i,sizingStyle:a}=Ze(t);V.setAttribute("style",`${a};${Ge};max-width:${n}px;max-height:${o}px`),V.value=e||" ";let d=V.scrollWidth,f=V.scrollHeight;return i==="border-box"?(d+=r,f+=r):i==="content-box"&&(d-=s,f-=s),{width:Math.min(d,n),height:Math.min(f,o)}}const tt=c.memo(function({x:e,y:n,maxWidth:o,maxHeight:s,size:r,color:i,value:a,onChange:d,onBlur:f}){const l=c.useRef(null),h=c.useRef(null),[u,g]=c.useState(0),[m,v]=c.useState(0),S=()=>(l.current||(l.current=document.createElement("div")),l.current);return c.useLayoutEffect(()=>(l.current&&(document.body.appendChild(l.current),requestAnimationFrame(()=>{var C;(C=h.current)==null||C.focus()})),()=>{var C;(C=l.current)==null||C.remove()}),[]),c.useLayoutEffect(()=>{if(!h.current)return;const{width:C,height:x}=et(h.current,a,o,s);g(C),v(x)},[a,o,s]),ve.createPortal(R("textarea",{ref:h,className:"screenshots-textarea",style:{color:i,width:u,height:m,maxWidth:o,maxHeight:s,fontSize:r,lineHeight:`${r}px`,transform:`translate(${e}px, ${n}px)`},value:a,onChange:C=>d&&d(C.target.value),onBlur:C=>f&&f(C)}),S())});function ae(t){const e=G();c.useEffect(()=>(e.on("drawselect",t),()=>{e.off("drawselect",t)}),[t,e])}const ge={3:18,6:32,9:46};function nt(t,e){const{size:n,color:o,fontFamily:s,x:r,y:i,text:a}=e.data;t.fillStyle=o,t.textAlign="left",t.textBaseline="top",t.font=`${n}px ${s}`;const d=e.editHistory.reduce((f,{data:l})=>({x:f.x+l.x2-l.x1,y:f.y+l.y2-l.y1}),{x:0,y:0});a.split(`
`).forEach((f,l)=>{t.fillText(f,r+d.x,i+d.y+l*n)})}function st(t,e,n){t.textAlign="left",t.textBaseline="top",t.font=`${e.data.size}px ${e.data.fontFamily}`;let o=0,s=0;e.data.text.split(`
`).forEach(h=>{const u=t.measureText(h);o<u.width&&(o=u.width),s+=e.data.size});const{x:r,y:i}=e.editHistory.reduce((h,{data:u})=>({x:h.x+u.x2-u.x1,y:h.y+u.y2-u.y1}),{x:0,y:0}),a=e.data.x+r,d=e.data.y+i,f=a+o,l=d+s;return n.x>=a&&n.x<=f&&n.y>=d&&n.y<=l}function ot(){const t=Y(),[e,n]=T(),[o]=J(),[s,r]=j(),[,i]=A(),a=I(),[d,f]=c.useState(3),[l,h]=c.useState("#ee5126"),u=c.useRef(null),g=c.useRef(null),[m,v]=c.useState(null),[S,C]=c.useState(""),x=s==="Text",M=c.useCallback(()=>{r.set("Text"),i.set("default")},[r,i]),y=c.useCallback(()=>{x||(M(),n.clearSelect())},[x,M,n]),p=c.useCallback(P=>{u.current&&(u.current.data.size=ge[P]),f(P)},[]),w=c.useCallback(P=>{u.current&&(u.current.data.color=P),h(P)},[]),_=c.useCallback(P=>{C(P),x&&u.current&&(u.current.data.text=P)},[x]),k=c.useCallback(()=>{u.current&&u.current.data.text&&n.push(u.current),u.current=null,C(""),v(null)},[n]),z=c.useCallback((P,W)=>{P.name==="Text"&&(M(),g.current={type:D.Edit,data:{x1:W.clientX,y1:W.clientY,x2:W.clientX,y2:W.clientY},source:P},n.select(P))},[M,n]),E=c.useCallback(P=>{if(!x||!a.current||u.current||!o)return;const{left:W,top:de}=a.current.canvas.getBoundingClientRect(),fe=window.getComputedStyle(a.current.canvas).fontFamily,se=P.clientX-W,oe=P.clientY-de;u.current={name:"Text",type:D.Source,data:{size:ge[d],color:l,fontFamily:fe,x:se,y:oe,text:""},editHistory:[],draw:nt,isHit:st},v({x:P.clientX,y:P.clientY,maxWidth:o.width-se,maxHeight:o.height-oe})},[x,d,l,o,a]),$=c.useCallback(P=>{x&&g.current&&(g.current.data.x2=P.clientX,g.current.data.y2=P.clientY,e.top!==g.current?(g.current.source.editHistory.push(g.current),n.push(g.current)):n.set(e))},[x,e,n]),ce=c.useCallback(()=>{x&&(g.current=null)},[x]);return ae(z),ee(E),te($),ne(ce),H(ye,{children:[R(N,{title:t.operation_text_title,icon:"icon-text",checked:x,onClick:y,option:R(ie,{size:d,color:l,onSizeChange:p,onColorChange:w})}),x&&m&&R(tt,{x:m.x,y:m.y,maxWidth:m.maxWidth,maxHeight:m.maxHeight,size:ge[d],color:l,value:S,onChange:_,onBlur:k})]})}const Se=4;function O(t,e,n){t.lineWidth=1,t.strokeStyle="#000000",t.fillStyle="#ffffff",t.beginPath(),t.arc(e,n,Se,0,2*Math.PI),t.fill(),t.stroke()}function he(t,e,n){e.draw(t,e);const{data:o}=t.getImageData(n.x,n.y,1,1);return o.some(s=>s!==0)}function B(t,e,n){if(!t)return!1;const{left:o,top:s}=t.getBoundingClientRect(),r=e.clientX-o,i=e.clientY-s;return(n.x-r)**2+(n.y-i)**2<Se**2}function rt(t,e){const{size:n,color:o,points:s}=e.data;t.lineCap="round",t.lineJoin="round",t.lineWidth=n,t.strokeStyle=o;const r=e.editHistory.reduce((i,{data:a})=>({x:i.x+a.x2-a.x1,y:i.y+a.y2-a.y1}),{x:0,y:0});t.beginPath(),s.forEach((i,a)=>{a===0?t.moveTo(i.x+r.x,i.y+r.y):t.lineTo(i.x+r.x,i.y+r.y)}),t.stroke(),e.isSelected&&(t.lineWidth=1,t.strokeStyle="rgba(0,0,0,0)",t.beginPath(),s.forEach((i,a)=>{a===0?t.moveTo(i.x+r.x,i.y+r.y):t.lineTo(i.x+r.x,i.y+r.y)}),t.stroke())}function it(){const t=Y(),[,e]=A(),[n,o]=j(),s=I(),[r,i]=T(),[a,d]=c.useState(3),[f,l]=c.useState("#ee5126"),h=c.useRef(null),u=c.useRef(null),g=n==="Brush",m=c.useCallback(()=>{o.set("Brush"),e.set("default")},[o,e]),v=c.useCallback(()=>{g||(m(),i.clearSelect())},[g,m,i]),S=c.useCallback((y,p)=>{y.name==="Brush"&&(m(),u.current={type:D.Edit,data:{x1:p.clientX,y1:p.clientY,x2:p.clientX,y2:p.clientY},source:y},i.select(y))},[m,i]),C=c.useCallback(y=>{if(!g||h.current||!s.current)return;const{left:p,top:w}=s.current.canvas.getBoundingClientRect();h.current={name:"Brush",type:D.Source,data:{size:a,color:f,points:[{x:y.clientX-p,y:y.clientY-w}]},editHistory:[],draw:rt,isHit:he}},[g,s,a,f]),x=c.useCallback(y=>{if(!(!g||!s.current)){if(u.current)u.current.data.x2=y.clientX,u.current.data.y2=y.clientY,r.top!==u.current?(u.current.source.editHistory.push(u.current),i.push(u.current)):i.set(r);else if(h.current){const{left:p,top:w}=s.current.canvas.getBoundingClientRect();h.current.data.points.push({x:y.clientX-p,y:y.clientY-w}),r.top!==h.current?i.push(h.current):i.set(r)}}},[g,r,s,i]),M=c.useCallback(()=>{g&&(h.current&&i.clearSelect(),h.current=null,u.current=null)},[g,i]);return ae(S),ee(C),te(x),ne(M),R(N,{title:t.operation_brush_title,icon:"icon-brush",checked:g,onClick:v,option:R(ie,{size:a,color:f,onSizeChange:d,onColorChange:l})})}function Re(t){let{x1:e,y1:n,x2:o,y2:s}=t.data;return t.editHistory.forEach(({data:r})=>{const i=r.x2-r.x1,a=r.y2-r.y1;r.type===ue.Move?(e+=i,n+=a,o+=i,s+=a):r.type===ue.MoveStart?(e+=i,n+=a):r.type===ue.MoveEnd&&(o+=i,s+=a)}),{...t.data,x1:e,x2:o,y1:n,y2:s}}function at(t,e){const{size:n,color:o,x1:s,x2:r,y1:i,y2:a}=Re(e);t.lineCap="round",t.lineJoin="bevel",t.lineWidth=n,t.strokeStyle=o;const d=r-s,f=a-i,l=n*3,h=Math.atan2(f,d);t.beginPath(),t.moveTo(s,i),t.lineTo(r,a),t.lineTo(r-l*Math.cos(h-Math.PI/6),a-l*Math.sin(h-Math.PI/6)),t.moveTo(r,a),t.lineTo(r-l*Math.cos(h+Math.PI/6),a-l*Math.sin(h+Math.PI/6)),t.stroke(),e.isSelected&&(O(t,s,i),O(t,r,a))}var ue=(t=>(t[t.Move=0]="Move",t[t.MoveStart=1]="MoveStart",t[t.MoveEnd=2]="MoveEnd",t))(ue||{});function ct(){const t=Y(),[,e]=A(),[n,o]=j(),[s,r]=T(),i=I(),[a,d]=c.useState(3),[f,l]=c.useState("#ee5126"),h=c.useRef(null),u=c.useRef(null),g=n==="Arrow",m=c.useCallback(()=>{o.set("Arrow"),e.set("default")},[o,e]),v=c.useCallback(()=>{g||(m(),r.clearSelect())},[g,m,r]),S=c.useCallback((y,p)=>{if(y.name!=="Arrow"||!i.current)return;const w=y;m();const{x1:_,y1:k,x2:z,y2:E}=Re(w);let $=0;B(i.current.canvas,p,{x:_,y:k})?$=1:B(i.current.canvas,p,{x:z,y:E})&&($=2),u.current={type:D.Edit,data:{type:$,x1:p.clientX,y1:p.clientY,x2:p.clientX,y2:p.clientY},source:w},r.select(y)},[i,m,r]),C=c.useCallback(y=>{if(!g||h.current||!i.current)return;const{left:p,top:w}=i.current.canvas.getBoundingClientRect();h.current={name:"Arrow",type:D.Source,data:{size:a,color:f,x1:y.clientX-p,y1:y.clientY-w,x2:y.clientX-p,y2:y.clientY-w},editHistory:[],draw:at,isHit:he}},[g,f,a,i]),x=c.useCallback(y=>{if(!(!g||!i.current)){if(u.current)u.current.data.x2=y.clientX,u.current.data.y2=y.clientY,s.top!==u.current?(u.current.source.editHistory.push(u.current),r.push(u.current)):r.set(s);else if(h.current){const{left:p,top:w}=i.current.canvas.getBoundingClientRect();h.current.data.x2=y.clientX-p,h.current.data.y2=y.clientY-w,s.top!==h.current?r.push(h.current):r.set(s)}}},[g,s,i,r]),M=c.useCallback(()=>{g&&(h.current&&r.clearSelect(),h.current=null,u.current=null)},[g,r]);return ae(S),ee(C),te(x),ne(M),R(N,{title:t.operation_arrow_title,icon:"icon-arrow",checked:g,onClick:v,option:R(ie,{size:a,color:f,onSizeChange:d,onColorChange:l})})}function xe(t){let{x1:e,y1:n,x2:o,y2:s}=t.data;return t.editHistory.forEach(({data:r})=>{const i=r.x2-r.x1,a=r.y2-r.y1;r.type===F.Move?(e+=i,n+=a,o+=i,s+=a):r.type===F.ResizeTop?n+=a:r.type===F.ResizeRightTop?(o+=i,n+=a):r.type===F.ResizeRight?o+=i:r.type===F.ResizeRightBottom?(o+=i,s+=a):r.type===F.ResizeBottom?s+=a:r.type===F.ResizeLeftBottom?(e+=i,s+=a):r.type===F.ResizeLeft?e+=i:r.type===F.ResizeLeftTop&&(e+=i,n+=a)}),{...t.data,x1:e,x2:o,y1:n,y2:s}}function lt(t,e){const{size:n,color:o,x1:s,y1:r,x2:i,y2:a}=xe(e);t.lineCap="butt",t.lineJoin="miter",t.lineWidth=n,t.strokeStyle=o;const d=(s+i)/2,f=(r+a)/2,l=Math.abs(i-s)/2,h=Math.abs(a-r)/2,u=.5522848,g=l*u,m=h*u;t.beginPath(),t.moveTo(d-l,f),t.bezierCurveTo(d-l,f-m,d-g,f-h,d,f-h),t.bezierCurveTo(d+g,f-h,d+l,f-m,d+l,f),t.bezierCurveTo(d+l,f+m,d+g,f+h,d,f+h),t.bezierCurveTo(d-g,f+h,d-l,f+m,d-l,f),t.closePath(),t.stroke(),e.isSelected&&(t.lineWidth=1,t.strokeStyle="#000000",t.fillStyle="#ffffff",t.beginPath(),t.moveTo(s,r),t.lineTo(i,r),t.lineTo(i,a),t.lineTo(s,a),t.closePath(),t.stroke(),O(t,(s+i)/2,r),O(t,i,r),O(t,i,(r+a)/2),O(t,i,a),O(t,(s+i)/2,a),O(t,s,a),O(t,s,(r+a)/2),O(t,s,r))}var F=(t=>(t[t.Move=0]="Move",t[t.ResizeTop=1]="ResizeTop",t[t.ResizeRightTop=2]="ResizeRightTop",t[t.ResizeRight=3]="ResizeRight",t[t.ResizeRightBottom=4]="ResizeRightBottom",t[t.ResizeBottom=5]="ResizeBottom",t[t.ResizeLeftBottom=6]="ResizeLeftBottom",t[t.ResizeLeft=7]="ResizeLeft",t[t.ResizeLeftTop=8]="ResizeLeftTop",t))(F||{});function ut(){const t=Y(),[e,n]=T(),[o,s]=j(),[,r]=A(),i=I(),[a,d]=c.useState(3),[f,l]=c.useState("#ee5126"),h=c.useRef(null),u=c.useRef(null),g=o==="Ellipse",m=c.useCallback(()=>{s.set("Ellipse"),r.set("crosshair")},[s,r]),v=c.useCallback(()=>{g||(m(),n.clearSelect())},[g,m,n]),S=c.useCallback((y,p)=>{if(y.name!=="Ellipse"||!i.current)return;const w=y;m();const{x1:_,y1:k,x2:z,y2:E}=xe(w);let $=0;B(i.current.canvas,p,{x:(_+z)/2,y:k})?$=1:B(i.current.canvas,p,{x:z,y:k})?$=2:B(i.current.canvas,p,{x:z,y:(k+E)/2})?$=3:B(i.current.canvas,p,{x:z,y:E})?$=4:B(i.current.canvas,p,{x:(_+z)/2,y:E})?$=5:B(i.current.canvas,p,{x:_,y:E})?$=6:B(i.current.canvas,p,{x:_,y:(k+E)/2})?$=7:B(i.current.canvas,p,{x:_,y:k})&&($=8),u.current={type:D.Edit,data:{type:$,x1:p.clientX,y1:p.clientY,x2:p.clientX,y2:p.clientY},source:w},n.select(y)},[i,m,n]),C=c.useCallback(y=>{if(!g||!i.current||h.current)return;const{left:p,top:w}=i.current.canvas.getBoundingClientRect(),_=y.clientX-p,k=y.clientY-w;h.current={name:"Ellipse",type:D.Source,data:{size:a,color:f,x1:_,y1:k,x2:_,y2:k},editHistory:[],draw:lt,isHit:he}},[g,a,f,i]),x=c.useCallback(y=>{if(!(!g||!i.current)){if(u.current)u.current.data.x2=y.clientX,u.current.data.y2=y.clientY,e.top!==u.current?(u.current.source.editHistory.push(u.current),n.push(u.current)):n.set(e);else if(h.current){const{left:p,top:w}=i.current.canvas.getBoundingClientRect();h.current.data.x2=y.clientX-p,h.current.data.y2=y.clientY-w,e.top!==h.current?n.push(h.current):n.set(e)}}},[g,i,e,n]),M=c.useCallback(()=>{g&&(h.current&&n.clearSelect(),h.current=null,u.current=null)},[g,n]);return ae(S),ee(C),te(x),ne(M),R(N,{title:t.operation_ellipse_title,icon:"icon-ellipse",checked:g,onClick:v,option:R(ie,{size:a,color:f,onSizeChange:d,onColorChange:l})})}function _e(t){let{x1:e,y1:n,x2:o,y2:s}=t.data;return t.editHistory.forEach(({data:r})=>{const i=r.x2-r.x1,a=r.y2-r.y1;r.type===X.Move?(e+=i,n+=a,o+=i,s+=a):r.type===X.ResizeTop?n+=a:r.type===X.ResizeRightTop?(o+=i,n+=a):r.type===X.ResizeRight?o+=i:r.type===X.ResizeRightBottom?(o+=i,s+=a):r.type===X.ResizeBottom?s+=a:r.type===X.ResizeLeftBottom?(e+=i,s+=a):r.type===X.ResizeLeft?e+=i:r.type===X.ResizeLeftTop&&(e+=i,n+=a)}),{...t.data,x1:e,x2:o,y1:n,y2:s}}function ht(t,e){const{size:n,color:o,x1:s,y1:r,x2:i,y2:a}=_e(e);t.lineCap="butt",t.lineJoin="miter",t.lineWidth=n,t.strokeStyle=o,t.beginPath(),t.moveTo(s,r),t.lineTo(i,r),t.lineTo(i,a),t.lineTo(s,a),t.closePath(),t.stroke(),e.isSelected&&(t.lineWidth=1,t.strokeStyle="#000000",t.fillStyle="#ffffff",O(t,(s+i)/2,r),O(t,i,r),O(t,i,(r+a)/2),O(t,i,a),O(t,(s+i)/2,a),O(t,s,a),O(t,s,(r+a)/2),O(t,s,r))}var X=(t=>(t[t.Move=0]="Move",t[t.ResizeTop=1]="ResizeTop",t[t.ResizeRightTop=2]="ResizeRightTop",t[t.ResizeRight=3]="ResizeRight",t[t.ResizeRightBottom=4]="ResizeRightBottom",t[t.ResizeBottom=5]="ResizeBottom",t[t.ResizeLeftBottom=6]="ResizeLeftBottom",t[t.ResizeLeft=7]="ResizeLeft",t[t.ResizeLeftTop=8]="ResizeLeftTop",t))(X||{});function dt(){const t=Y(),[e,n]=T(),[o,s]=j(),[,r]=A(),i=I(),[a,d]=c.useState(3),[f,l]=c.useState("#ee5126"),h=c.useRef(null),u=c.useRef(null),g=o==="Rectangle",m=c.useCallback(()=>{s.set("Rectangle"),r.set("crosshair")},[s,r]),v=c.useCallback(()=>{g||(m(),n.clearSelect())},[g,m,n]),S=c.useCallback((y,p)=>{if(y.name!=="Rectangle"||!i.current)return;const w=y;m();const{x1:_,y1:k,x2:z,y2:E}=_e(w);let $=0;B(i.current.canvas,p,{x:(_+z)/2,y:k})?$=1:B(i.current.canvas,p,{x:z,y:k})?$=2:B(i.current.canvas,p,{x:z,y:(k+E)/2})?$=3:B(i.current.canvas,p,{x:z,y:E})?$=4:B(i.current.canvas,p,{x:(_+z)/2,y:E})?$=5:B(i.current.canvas,p,{x:_,y:E})?$=6:B(i.current.canvas,p,{x:_,y:(k+E)/2})?$=7:B(i.current.canvas,p,{x:_,y:k})&&($=8),u.current={type:D.Edit,data:{type:$,x1:p.clientX,y1:p.clientY,x2:p.clientX,y2:p.clientY},source:y},n.select(y)},[i,m,n]),C=c.useCallback(y=>{if(!g||!i.current||h.current)return;const{left:p,top:w}=i.current.canvas.getBoundingClientRect(),_=y.clientX-p,k=y.clientY-w;h.current={name:"Rectangle",type:D.Source,data:{size:a,color:f,x1:_,y1:k,x2:_,y2:k},editHistory:[],draw:ht,isHit:he}},[g,a,f,i]),x=c.useCallback(y=>{if(!(!g||!i.current)){if(u.current)u.current.data.x2=y.clientX,u.current.data.y2=y.clientY,e.top!==u.current?(u.current.source.editHistory.push(u.current),n.push(u.current)):n.set(e);else if(h.current){const{left:p,top:w}=i.current.canvas.getBoundingClientRect(),_=h.current.data;_.x2=y.clientX-p,_.y2=y.clientY-w,e.top!==h.current?n.push(h.current):n.set(e)}}},[g,i,e,n]),M=c.useCallback(()=>{g&&(h.current&&n.clearSelect(),h.current=null,u.current=null)},[g,n]);return ae(S),ee(C),te(x),ne(M),R(N,{title:t.operation_rectangle_title,icon:"icon-rectangle",checked:g,onClick:v,option:R(ie,{size:a,color:f,onSizeChange:d,onColorChange:l})})}function ft(){const{image:t,width:e,height:n,history:o,bounds:s,lang:r}=L(),i=I(),[,a]=T(),d=K(),f=Z(),l=c.useCallback(()=>{a.clearSelect(),setTimeout(()=>{!i.current||!t||!s||U({image:t,width:e,height:n,history:o,bounds:s}).then(h=>{d("onSearch",h),f()})})},[i,a,t,e,n,o,s,d,f]);return R(N,{title:r.operation_search_title,icon:"icon-search",onClick:l})}class b{constructor(e,n,o,s,r){this._legacyCanvasSize=b.DEFAULT_CANVAS_SIZE,this._preferredCamera="environment",this._maxScansPerSecond=25,this._lastScanTimestamp=-1,this._destroyed=this._flashOn=this._paused=this._active=!1,this.$video=e,this.$canvas=document.createElement("canvas"),o&&typeof o=="object"?this._onDecode=n:(console.warn(o||s||r?"You're using a deprecated version of the QrScanner constructor which will be removed in the future":"Note that the type of the scan result passed to onDecode will change in the future. To already switch to the new api today, you can pass returnDetailedScanResult: true."),this._legacyOnDecode=n),n=typeof o=="object"?o:{},this._onDecodeError=n.onDecodeError||(typeof o=="function"?o:this._onDecodeError),this._calculateScanRegion=n.calculateScanRegion||(typeof s=="function"?s:this._calculateScanRegion),this._preferredCamera=n.preferredCamera||r||this._preferredCamera,this._legacyCanvasSize=typeof o=="number"?o:typeof s=="number"?s:this._legacyCanvasSize,this._maxScansPerSecond=n.maxScansPerSecond||this._maxScansPerSecond,this._onPlay=this._onPlay.bind(this),this._onLoadedMetaData=this._onLoadedMetaData.bind(this),this._onVisibilityChange=this._onVisibilityChange.bind(this),this._updateOverlay=this._updateOverlay.bind(this),e.disablePictureInPicture=!0,e.playsInline=!0,e.muted=!0;let i=!1;if(e.hidden&&(e.hidden=!1,i=!0),document.body.contains(e)||(document.body.appendChild(e),i=!0),o=e.parentElement,n.highlightScanRegion||n.highlightCodeOutline){if(s=!!n.overlay,this.$overlay=n.overlay||document.createElement("div"),r=this.$overlay.style,r.position="absolute",r.display="none",r.pointerEvents="none",this.$overlay.classList.add("scan-region-highlight"),!s&&n.highlightScanRegion){this.$overlay.innerHTML='<svg class="scan-region-highlight-svg" viewBox="0 0 238 238" preserveAspectRatio="none" style="position:absolute;width:100%;height:100%;left:0;top:0;fill:none;stroke:#e9b213;stroke-width:4;stroke-linecap:round;stroke-linejoin:round"><path d="M31 2H10a8 8 0 0 0-8 8v21M207 2h21a8 8 0 0 1 8 8v21m0 176v21a8 8 0 0 1-8 8h-21m-176 0H10a8 8 0 0 1-8-8v-21"/></svg>';try{this.$overlay.firstElementChild.animate({transform:["scale(.98)","scale(1.01)"]},{duration:400,iterations:1/0,direction:"alternate",easing:"ease-in-out"})}catch{}o.insertBefore(this.$overlay,this.$video.nextSibling)}n.highlightCodeOutline&&(this.$overlay.insertAdjacentHTML("beforeend",'<svg class="code-outline-highlight" preserveAspectRatio="none" style="display:none;width:100%;height:100%;fill:none;stroke:#e9b213;stroke-width:5;stroke-dasharray:25;stroke-linecap:round;stroke-linejoin:round"><polygon/></svg>'),this.$codeOutlineHighlight=this.$overlay.lastElementChild)}this._scanRegion=this._calculateScanRegion(e),requestAnimationFrame(()=>{let a=window.getComputedStyle(e);a.display==="none"&&(e.style.setProperty("display","block","important"),i=!0),a.visibility!=="visible"&&(e.style.setProperty("visibility","visible","important"),i=!0),i&&(console.warn("QrScanner has overwritten the video hiding style to avoid Safari stopping the playback."),e.style.opacity="0",e.style.width="0",e.style.height="0",this.$overlay&&this.$overlay.parentElement&&this.$overlay.parentElement.removeChild(this.$overlay),delete this.$overlay,delete this.$codeOutlineHighlight),this.$overlay&&this._updateOverlay()}),e.addEventListener("play",this._onPlay),e.addEventListener("loadedmetadata",this._onLoadedMetaData),document.addEventListener("visibilitychange",this._onVisibilityChange),window.addEventListener("resize",this._updateOverlay),this._qrEnginePromise=b.createQrEngine()}static set WORKER_PATH(e){console.warn("Setting QrScanner.WORKER_PATH is not required and not supported anymore. Have a look at the README for new setup instructions.")}static async hasCamera(){try{return!!(await b.listCameras(!1)).length}catch{return!1}}static async listCameras(e=!1){if(!navigator.mediaDevices)return[];let n=async()=>(await navigator.mediaDevices.enumerateDevices()).filter(s=>s.kind==="videoinput"),o;try{e&&(await n()).every(s=>!s.label)&&(o=await navigator.mediaDevices.getUserMedia({audio:!1,video:!0}))}catch{}try{return(await n()).map((s,r)=>({id:s.deviceId,label:s.label||(r===0?"Default Camera":`Camera ${r+1}`)}))}finally{o&&(console.warn("Call listCameras after successfully starting a QR scanner to avoid creating a temporary video stream"),b._stopVideoStream(o))}}async hasFlash(){let e;try{if(this.$video.srcObject){if(!(this.$video.srcObject instanceof MediaStream))return!1;e=this.$video.srcObject}else e=(await this._getCameraStream()).stream;return"torch"in e.getVideoTracks()[0].getSettings()}catch{return!1}finally{e&&e!==this.$video.srcObject&&(console.warn("Call hasFlash after successfully starting the scanner to avoid creating a temporary video stream"),b._stopVideoStream(e))}}isFlashOn(){return this._flashOn}async toggleFlash(){this._flashOn?await this.turnFlashOff():await this.turnFlashOn()}async turnFlashOn(){if(!this._flashOn&&!this._destroyed&&(this._flashOn=!0,this._active&&!this._paused))try{if(!await this.hasFlash())throw"No flash available";await this.$video.srcObject.getVideoTracks()[0].applyConstraints({advanced:[{torch:!0}]})}catch(e){throw this._flashOn=!1,e}}async turnFlashOff(){this._flashOn&&(this._flashOn=!1,await this._restartVideoStream())}destroy(){this.$video.removeEventListener("loadedmetadata",this._onLoadedMetaData),this.$video.removeEventListener("play",this._onPlay),document.removeEventListener("visibilitychange",this._onVisibilityChange),window.removeEventListener("resize",this._updateOverlay),this._destroyed=!0,this._flashOn=!1,this.stop(),b._postWorkerMessage(this._qrEnginePromise,"close")}async start(){if(this._destroyed)throw Error("The QR scanner can not be started as it had been destroyed.");if((!this._active||this._paused)&&(window.location.protocol!=="https:"&&console.warn("The camera stream is only accessible if the page is transferred via https."),this._active=!0,!document.hidden))if(this._paused=!1,this.$video.srcObject)await this.$video.play();else try{let{stream:e,facingMode:n}=await this._getCameraStream();!this._active||this._paused?b._stopVideoStream(e):(this._setVideoMirror(n),this.$video.srcObject=e,await this.$video.play(),this._flashOn&&(this._flashOn=!1,this.turnFlashOn().catch(()=>{})))}catch(e){if(!this._paused)throw this._active=!1,e}}stop(){this.pause(),this._active=!1}async pause(e=!1){if(this._paused=!0,!this._active)return!0;this.$video.pause(),this.$overlay&&(this.$overlay.style.display="none");let n=()=>{this.$video.srcObject instanceof MediaStream&&(b._stopVideoStream(this.$video.srcObject),this.$video.srcObject=null)};return e?(n(),!0):(await new Promise(o=>setTimeout(o,300)),this._paused?(n(),!0):!1)}async setCamera(e){e!==this._preferredCamera&&(this._preferredCamera=e,await this._restartVideoStream())}static async scanImage(e,n,o,s,r=!1,i=!1){let a,d=!1;n&&("scanRegion"in n||"qrEngine"in n||"canvas"in n||"disallowCanvasResizing"in n||"alsoTryWithoutScanRegion"in n||"returnDetailedScanResult"in n)?(a=n.scanRegion,o=n.qrEngine,s=n.canvas,r=n.disallowCanvasResizing||!1,i=n.alsoTryWithoutScanRegion||!1,d=!0):console.warn(n||o||s||r||i?"You're using a deprecated api for scanImage which will be removed in the future.":"Note that the return type of scanImage will change in the future. To already switch to the new api today, you can pass returnDetailedScanResult: true."),n=!!o;try{let f,l;[o,f]=await Promise.all([o||b.createQrEngine(),b._loadImage(e)]),[s,l]=b._drawToCanvas(f,a,s,r);let h;if(o instanceof Worker){let u=o;n||b._postWorkerMessageSync(u,"inversionMode","both"),h=await new Promise((g,m)=>{let v,S,C,x=-1;S=y=>{y.data.id===x&&(u.removeEventListener("message",S),u.removeEventListener("error",C),clearTimeout(v),y.data.data!==null?g({data:y.data.data,cornerPoints:b._convertPoints(y.data.cornerPoints,a)}):m(b.NO_QR_CODE_FOUND))},C=y=>{u.removeEventListener("message",S),u.removeEventListener("error",C),clearTimeout(v),m("Scanner error: "+(y?y.message||y:"Unknown Error"))},u.addEventListener("message",S),u.addEventListener("error",C),v=setTimeout(()=>C("timeout"),1e4);let M=l.getImageData(0,0,s.width,s.height);x=b._postWorkerMessageSync(u,"decode",M,[M.data.buffer])})}else h=await Promise.race([new Promise((u,g)=>window.setTimeout(()=>g("Scanner error: timeout"),1e4)),(async()=>{try{var[u]=await o.detect(s);if(!u)throw b.NO_QR_CODE_FOUND;return{data:u.rawValue,cornerPoints:b._convertPoints(u.cornerPoints,a)}}catch(g){if(u=g.message||g,/not implemented|service unavailable/.test(u))return b._disableBarcodeDetector=!0,b.scanImage(e,{scanRegion:a,canvas:s,disallowCanvasResizing:r,alsoTryWithoutScanRegion:i});throw`Scanner error: ${u}`}})()]);return d?h:h.data}catch(f){if(!a||!i)throw f;let l=await b.scanImage(e,{qrEngine:o,canvas:s,disallowCanvasResizing:r});return d?l:l.data}finally{n||b._postWorkerMessage(o,"close")}}setGrayscaleWeights(e,n,o,s=!0){b._postWorkerMessage(this._qrEnginePromise,"grayscaleWeights",{red:e,green:n,blue:o,useIntegerApproximation:s})}setInversionMode(e){b._postWorkerMessage(this._qrEnginePromise,"inversionMode",e)}static async createQrEngine(e){if(e&&console.warn("Specifying a worker path is not required and not supported anymore."),e=()=>Me(()=>import("./chunks/qr-scanner-worker.min.5f44a019.js"),[]).then(o=>o.createWorker()),!(!b._disableBarcodeDetector&&"BarcodeDetector"in window&&BarcodeDetector.getSupportedFormats&&(await BarcodeDetector.getSupportedFormats()).includes("qr_code")))return e();let n=navigator.userAgentData;return n&&n.brands.some(({brand:o})=>/Chromium/i.test(o))&&/mac ?OS/i.test(n.platform)&&await n.getHighEntropyValues(["architecture","platformVersion"]).then(({architecture:o,platformVersion:s})=>/arm/i.test(o||"arm")&&13<=parseInt(s||"13")).catch(()=>!0)?e():new BarcodeDetector({formats:["qr_code"]})}_onPlay(){this._scanRegion=this._calculateScanRegion(this.$video),this._updateOverlay(),this.$overlay&&(this.$overlay.style.display=""),this._scanFrame()}_onLoadedMetaData(){this._scanRegion=this._calculateScanRegion(this.$video),this._updateOverlay()}_onVisibilityChange(){document.hidden?this.pause():this._active&&this.start()}_calculateScanRegion(e){let n=Math.round(.6666666666666666*Math.min(e.videoWidth,e.videoHeight));return{x:Math.round((e.videoWidth-n)/2),y:Math.round((e.videoHeight-n)/2),width:n,height:n,downScaledWidth:this._legacyCanvasSize,downScaledHeight:this._legacyCanvasSize}}_updateOverlay(){requestAnimationFrame(()=>{if(this.$overlay){var e=this.$video,n=e.videoWidth,o=e.videoHeight,s=e.offsetWidth,r=e.offsetHeight,i=e.offsetLeft,a=e.offsetTop,d=window.getComputedStyle(e),f=d.objectFit,l=n/o,h=s/r;switch(f){case"none":var u=n,g=o;break;case"fill":u=s,g=r;break;default:(f==="cover"?l>h:l<h)?(g=r,u=g*l):(u=s,g=u/l),f==="scale-down"&&(u=Math.min(u,n),g=Math.min(g,o))}var[m,v]=d.objectPosition.split(" ").map((C,x)=>{const M=parseFloat(C);return C.endsWith("%")?(x?r-g:s-u)*M/100:M});d=this._scanRegion.width||n,h=this._scanRegion.height||o,f=this._scanRegion.x||0;var S=this._scanRegion.y||0;l=this.$overlay.style,l.width=`${d/n*u}px`,l.height=`${h/o*g}px`,l.top=`${a+v+S/o*g}px`,o=/scaleX\(-1\)/.test(e.style.transform),l.left=`${i+(o?s-m-u:m)+(o?n-f-d:f)/n*u}px`,l.transform=e.style.transform}})}static _convertPoints(e,n){if(!n)return e;let o=n.x||0,s=n.y||0,r=n.width&&n.downScaledWidth?n.width/n.downScaledWidth:1;n=n.height&&n.downScaledHeight?n.height/n.downScaledHeight:1;for(let i of e)i.x=i.x*r+o,i.y=i.y*n+s;return e}_scanFrame(){!this._active||this.$video.paused||this.$video.ended||("requestVideoFrameCallback"in this.$video?this.$video.requestVideoFrameCallback.bind(this.$video):requestAnimationFrame)(async()=>{if(!(1>=this.$video.readyState)){var e=Date.now()-this._lastScanTimestamp,n=1e3/this._maxScansPerSecond;e<n&&await new Promise(s=>setTimeout(s,n-e)),this._lastScanTimestamp=Date.now();try{var o=await b.scanImage(this.$video,{scanRegion:this._scanRegion,qrEngine:this._qrEnginePromise,canvas:this.$canvas})}catch(s){if(!this._active)return;this._onDecodeError(s)}!b._disableBarcodeDetector||await this._qrEnginePromise instanceof Worker||(this._qrEnginePromise=b.createQrEngine()),o?(this._onDecode?this._onDecode(o):this._legacyOnDecode&&this._legacyOnDecode(o.data),this.$codeOutlineHighlight&&(clearTimeout(this._codeOutlineHighlightRemovalTimeout),this._codeOutlineHighlightRemovalTimeout=void 0,this.$codeOutlineHighlight.setAttribute("viewBox",`${this._scanRegion.x||0} ${this._scanRegion.y||0} ${this._scanRegion.width||this.$video.videoWidth} ${this._scanRegion.height||this.$video.videoHeight}`),this.$codeOutlineHighlight.firstElementChild.setAttribute("points",o.cornerPoints.map(({x:s,y:r})=>`${s},${r}`).join(" ")),this.$codeOutlineHighlight.style.display="")):this.$codeOutlineHighlight&&!this._codeOutlineHighlightRemovalTimeout&&(this._codeOutlineHighlightRemovalTimeout=setTimeout(()=>this.$codeOutlineHighlight.style.display="none",100))}this._scanFrame()})}_onDecodeError(e){e!==b.NO_QR_CODE_FOUND&&console.log(e)}async _getCameraStream(){if(!navigator.mediaDevices)throw"Camera not found.";let e=/^(environment|user)$/.test(this._preferredCamera)?"facingMode":"deviceId",n=[{width:{min:1024}},{width:{min:768}},{}],o=n.map(s=>Object.assign({},s,{[e]:{exact:this._preferredCamera}}));for(let s of[...o,...n])try{let r=await navigator.mediaDevices.getUserMedia({video:s,audio:!1}),i=this._getFacingMode(r)||(s.facingMode?this._preferredCamera:this._preferredCamera==="environment"?"user":"environment");return{stream:r,facingMode:i}}catch{}throw"Camera not found."}async _restartVideoStream(){let e=this._paused;await this.pause(!0)&&!e&&this._active&&await this.start()}static _stopVideoStream(e){for(let n of e.getTracks())n.stop(),e.removeTrack(n)}_setVideoMirror(e){this.$video.style.transform="scaleX("+(e==="user"?-1:1)+")"}_getFacingMode(e){return(e=e.getVideoTracks()[0])?/rear|back|environment/i.test(e.label)?"environment":/front|user|face/i.test(e.label)?"user":null:null}static _drawToCanvas(e,n,o,s=!1){o=o||document.createElement("canvas");let r=n&&n.x?n.x:0,i=n&&n.y?n.y:0,a=n&&n.width?n.width:e.videoWidth||e.width,d=n&&n.height?n.height:e.videoHeight||e.height;return s||(s=n&&n.downScaledWidth?n.downScaledWidth:a,n=n&&n.downScaledHeight?n.downScaledHeight:d,o.width!==s&&(o.width=s),o.height!==n&&(o.height=n)),n=o.getContext("2d",{alpha:!1}),n.imageSmoothingEnabled=!1,n.drawImage(e,r,i,a,d,0,0,o.width,o.height),[o,n]}static async _loadImage(e){if(e instanceof Image)return await b._awaitImageLoad(e),e;if(e instanceof HTMLVideoElement||e instanceof HTMLCanvasElement||e instanceof SVGImageElement||"OffscreenCanvas"in window&&e instanceof OffscreenCanvas||"ImageBitmap"in window&&e instanceof ImageBitmap)return e;if(e instanceof File||e instanceof Blob||e instanceof URL||typeof e=="string"){let n=new Image;n.src=e instanceof File||e instanceof Blob?URL.createObjectURL(e):e.toString();try{return await b._awaitImageLoad(n),n}finally{(e instanceof File||e instanceof Blob)&&URL.revokeObjectURL(n.src)}}else throw"Unsupported image type."}static async _awaitImageLoad(e){e.complete&&e.naturalWidth!==0||await new Promise((n,o)=>{let s=r=>{e.removeEventListener("load",s),e.removeEventListener("error",s),r instanceof ErrorEvent?o("Image load error"):n()};e.addEventListener("load",s),e.addEventListener("error",s)})}static async _postWorkerMessage(e,n,o,s){return b._postWorkerMessageSync(await e,n,o,s)}static _postWorkerMessageSync(e,n,o,s){if(!(e instanceof Worker))return-1;let r=b._workerMessageId++;return e.postMessage({id:r,type:n,data:o},s),r}}b.DEFAULT_CANVAS_SIZE=400;b.NO_QR_CODE_FOUND="No QR code found";b._disableBarcodeDetector=!1;b._workerMessageId=0;function gt(){const{image:t,width:e,height:n,history:o,bounds:s,lang:r}=L(),i=I(),[,a]=T(),d=K(),f=Z(),l=c.useCallback(()=>{a.clearSelect(),setTimeout(()=>{!i.current||!t||!s||U({image:t,width:e,height:n,history:o,bounds:s}).then(async h=>{try{const u=await b.scanImage(h);u&&d("onScan",u)}catch(u){console.error("Error:",u)}f()})})},[i,a,t,e,n,o,s,d,f]);return R(N,{title:r.operation_scan_title,icon:"icon-scan",onClick:l})}function mt(){const{image:t,width:e,height:n,history:o,bounds:s,lang:r}=L(),i=I(),[,a]=T(),d=K(),f=Z(),l=c.useCallback(()=>{a.clearSelect(),setTimeout(()=>{!i.current||!t||!s||U({image:t,width:e,height:n,history:o,bounds:s}).then(h=>{d("onPin",h,s),f()})})},[i,a,t,e,n,o,s,d,f]);return R(N,{title:r.operation_pin_title,icon:"icon-pin",onClick:l})}const pt=[mt,gt,ft,"|",dt,ut,ct,it,ot,Qe,"|",Ue,je,"|",Ae,Ve,Ye];const ke=pe.createContext(null),yt=c.memo(function(){const{width:e,height:n}=L(),[o]=J(),[s,r]=c.useState(null),[i,a]=c.useState(null),d=c.useRef(null),f=c.useCallback(h=>{h.stopPropagation()},[]),l=c.useCallback(h=>{h.preventDefault(),h.stopPropagation()},[]);return c.useEffect(()=>{if(!o||!d.current)return;const h=d.current.getBoundingClientRect();let u=o.x+o.width-h.width,g=o.y+o.height+10;u<0&&(u=0),u>e-h.width&&(u=e-h.width),g>n-h.height&&(g=n-h.height-10),(!i||Math.abs(i.x-u)>1||Math.abs(i.y-g)>1)&&a({x:u,y:g}),(!s||Math.abs(s.x-h.x)>1||Math.abs(s.y-h.y)>1||Math.abs(s.width-h.width)>1||Math.abs(s.height-h.height)>1)&&r({x:h.x,y:h.y,width:h.width,height:h.height})}),o?R(ke.Provider,{value:s,children:R("div",{ref:d,className:"screenshots-operations",style:{visibility:i?"visible":"hidden",transform:`translate(${(i==null?void 0:i.x)??0}px, ${(i==null?void 0:i.y)??0}px)`},onDoubleClick:f,onContextMenu:l,children:R("div",{className:"screenshots-operations-buttons",children:pt.map((h,u)=>h==="|"?R("div",{className:"screenshots-operations-divider"},u):R(h,{},u))})})}):null});function vt(t){const[e,n]=c.useState(null);return c.useEffect(()=>{if(n(null),t==null)return;const o=document.createElement("img"),s=()=>n(o),r=()=>n(null);return o.addEventListener("load",s),o.addEventListener("error",r),o.src=t,()=>{o.removeEventListener("load",s),o.removeEventListener("error",r)}},[t]),e}function wt({url:t,width:e,height:n,lang:o,className:s,...r}){const i=vt(t),a=c.useRef(null),d=c.useRef({}),[f,l]=c.useState({index:-1,stack:[]}),[h,u]=c.useState(null),[g,m]=c.useState("move"),[v,S]=c.useState(void 0),C={url:t,width:e,height:n,image:i,lang:{...we,...o},emiterRef:d,canvasContextRef:a,history:f,bounds:h,cursor:g,operation:v},x=c.useCallback((k,...z)=>{const E=r[k];typeof E=="function"&&E(...z)},[r]),M={call:x,setHistory:l,setBounds:u,setCursor:m,setOperation:S},y=["screenshots"];s&&y.push(s);const p=()=>{d.current={},l({index:-1,stack:[]}),u(null),m("move"),S(void 0)},w=c.useCallback(async k=>{if(!(k.button!==0||!i))if(h&&a.current)U({image:i,width:e,height:n,history:f,bounds:h}).then(z=>{x("onOk",z,h),p()});else{const z={x:0,y:0,width:e,height:n};U({image:i,width:e,height:n,history:f,bounds:z}).then(E=>{x("onOk",E,z),p()})}},[i,f,h,e,n,x]),_=c.useCallback(k=>{k.button===2&&(k.preventDefault(),x("onCancel"),p())},[x]);return c.useLayoutEffect(()=>{p()},[t]),R(me.Provider,{value:{store:C,dispatcher:M},children:H("div",{className:y.join(" "),style:{width:e,height:n},onDoubleClick:w,onContextMenu:_,children:[R(Le,{}),R(Fe,{ref:a}),R(yt,{})]})})}const Ct="/pear-rec/imgs/th.webp";function St(){const t=c.useCallback((o,s)=>{if(console.log("save",o,s),o){const r=URL.createObjectURL(o);console.log(r),window.open(r)}},[]),e=c.useCallback(()=>{console.log("cancel")},[]),n=c.useCallback((o,s)=>{if(console.log("ok",o,s),o){const r=URL.createObjectURL(o);console.log(r),window.open(r)}},[]);return R("div",{className:"body",children:R(wt,{url:Ct,width:window.innerWidth,height:window.innerHeight,lang:{operation_rectangle_title:"Rectangle"},onSave:t,onCancel:e,onOk:n})})}const kt=JSON.parse('{"title":"","description":"","frontmatter":{"layout":false},"headers":[],"relativePath":"screenshot/demo.md","filePath":"screenshot/demo.md"}'),Rt={name:"screenshot/demo.md"},bt=Object.assign(Rt,{setup(t){const e=$e();return ze(()=>{be(e.value).render(c.createElement(St,{},null))}),(n,o)=>(Ee(),De("div",null,[Pe("div",{ref_key:"el",ref:e,id:"root"},null,512)]))}});export{kt as __pageData,bt as default};
